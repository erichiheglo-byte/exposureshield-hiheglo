// api/_lib/auth.js
import { verifyJwt } from "./jwt.js";

function getBearerToken(req) {
  const h = (req.headers.authorization || req.headers.Authorization || "").toString().trim();
  if (!h) return "";
  const parts = h.split(" ");
  if (parts.length === 2 && /^Bearer$/i.test(parts[0])) return parts[1].trim();
  return "";
}

export function requireAuth(req, res) {
  const jwtSecret = (process.env.JWT_SECRET || "").toString().trim();
  if (!jwtSecret) {
    res.status(500).json({ error: "JWT_SECRET not configured" });
    return null;
  }

  const token = getBearerToken(req);
  if (!token) {
    res.status(401).json({ error: "Missing Authorization: Bearer <token>" });
    return null;
  }

  try {
    const payload = verifyJwt(token, jwtSecret);
    // Standard shape you can use everywhere:
    // payload.sub = user id, payload.email, payload.role
    return payload;
  } catch (e) {
    res.status(401).json({ error: "Invalid or expired token" });
    return null;
  }
}
